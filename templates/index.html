<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Manager</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .paper { background-color: #ffffff; margin: 10px 0; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .paper strong { font-size: 1.1em; }
        .paper p { color: #555555; margin-top: 10px; }
        .paper a { color: #1a73e8; text-decoration: none; }
        .paper a:hover { text-decoration: underline; }
        .edit-button, .delete-button { margin-top: 10px; background-color: #e8b732; }
        .delete-button { background-color: #e83232; }
        .recommendation-card { background-color: #fff; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .recommendation-card h5 { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="my-4">Paper Manager</h2>
        <form id="paperForm" class="mb-4">
            <input type="hidden" id="paperId">
            <div class="form-group">
                <input type="text" id="title" class="form-control" placeholder="Title" required>
            </div>
            <div class="form-group">
                <textarea id="summary" class="form-control" placeholder="Summary" required></textarea>
            </div>
            <div class="form-group">
                <input type="url" id="link" class="form-control" placeholder="Link" required>
            </div>
            <div class="form-group">
                <input type="text" id="source" class="form-control" placeholder="Source" required>
            </div>
            <div class="form-group">
                <input type="datetime-local" id="pubDate" class="form-control" placeholder="Publication Date" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Paper</button>
        </form>
        <div class="mb-3">
            <label for="sort">Sort by:</label>
            <select id="sort" class="form-control d-inline-block w-auto">
                <option value="pubDate">Date</option>
                <option value="title">Title</option>
                <option value="source">Source</option>
            </select>
            <label for="order" class="ml-2">Order:</label>
            <select id="order" class="form-control d-inline-block w-auto">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
            </select>
            <label for="sourceFilter" class="ml-2">Filter by Source:</label>
            <select id="sourceFilter" class="form-control d-inline-block w-auto">
                <option value="">All</option>
            </select>
            <button onclick="fetchPapers()" class="btn btn-secondary ml-2">Apply</button>
        </div>
        <input type="text" id="searchQuery" class="form-control mb-3" placeholder="Search...">
        <button onclick="searchPapers()" class="btn btn-info mb-3">Search</button>
        <div id="paperList"></div>
    </div>
    <div id="recommendationModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">If you liked this, then read this:</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="recentRecommendations"></div>
                    <hr>
                    <div id="oldRecommendations"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script>
        document.getElementById('paperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const paperId = document.getElementById('paperId').value;
            const newPaper = {
                title: document.getElementById('title').value,
                summary: document.getElementById('summary').value,
                link: document.getElementById('link').value,
                source: document.getElementById('source').value,
                pubDate: document.getElementById('pubDate').value,
            };

            if (paperId) {
                await fetch(`/papers/${paperId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newPaper),
                });
            } else {
                await fetch('/papers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newPaper),
                });
            }

            document.getElementById('paperForm').reset();
            document.getElementById('paperId').value = '';
            fetchPapers();
        });

        async function fetchPapers(page = 1) {
            const sortBy = document.getElementById('sort').value;
            const order = document.getElementById('order').value;
            const source = document.getElementById('sourceFilter').value;
            const perPage = 10;

            let url = `/papers?sort_by=${sortBy}&order=${order}&page=${page}&per_page=${perPage}`;
            if (source) {
                url += `&source=${source}`;
            }

            const response = await fetch(url);
            const papers = await response.json();
            const paperList = document.getElementById('paperList');
            paperList.innerHTML = '';
            papers.forEach(paper => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'paper';
                paperDiv.innerHTML = `
                    <strong>${paper.title}</strong><br>
                    <p>${paper.summary}</p>
                    <a href="${paper.link}" target="_blank">Read more</a><br>
                    <em>Source: ${paper.source} | Date: ${new Date(paper.pubDate).toLocaleString()}</em>
                    <button class="edit-button btn btn-warning mt-2" onclick="editPaper(${paper.id})">Edit</button>
                    <button class="delete-button btn btn-danger mt-2" onclick="deletePaper(${paper.id})">Delete</button>
                    <button class="btn btn-info mt-2" onclick="showRecommendations(${paper.id})">Show Recommendations</button>
                `;
                paperList.appendChild(paperDiv);
            });
        }

        async function editPaper(id) {
            const response = await fetch(`/papers/${id}`);
            const paper = await response.json();
            document.getElementById('paperId').value = paper.id;
            document.getElementById('title').value = paper.title;
            document.getElementById('summary').value = paper.summary;
            document.getElementById('link').value = paper.link;
            document.getElementById('source').value = paper.source;
            document.getElementById('pubDate').value = new Date(paper.pubDate).toISOString().slice(0, -1);
        }

        async function deletePaper(id) {
            if (confirm('Are you sure you want to delete this paper?')) {
                await fetch(`/papers/${id}`, {
                    method: 'DELETE',
                });
                fetchPapers();
            }
        }

        async function fetchSources() {
            const response = await fetch('/sources');
            const sources = await response.json();
            const sourceFilter = document.getElementById('sourceFilter');
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.text = source;
                sourceFilter.appendChild(option);
            });
        }

        async function searchPapers() {
            const query = document.getElementById('searchQuery').value;
            const response = await fetch(`/papers/search?query=${query}`);
            const papers = await response.json();
            const paperList = document.getElementById('paperList');
            paperList.innerHTML = '';
            papers.forEach(paper => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'paper';
                paperDiv.innerHTML = `
                    <strong>${paper.title}</strong><br>
                    <p>${paper.summary}</p>
                    <a href="${paper.link}" target="_blank">Read more</a><br>
                    <em>Source: ${paper.source} | Date: ${new Date(paper.pubDate).toLocaleString()}</em>
                    <button class="edit-button btn btn-warning mt-2" onclick="editPaper(${paper.id})">Edit</button>
                    <button class="delete-button btn btn-danger mt-2" onclick="deletePaper(${paper.id})">Delete</button>
                    <button class="btn btn-info mt-2" onclick="showRecommendations(${paper.id})">Show Recommendations</button>
                `;
                paperList.appendChild(paperDiv);
            });
        }

        async function showRecommendations(id) {
            const response = await fetch(`/papers/${id}/recommendations`);
            const data = await response.json();

            const recentRecommendations = data.recent;
            const oldRecommendations = data.old;

            const recentDiv = document.getElementById('recentRecommendations');
            const oldDiv = document.getElementById('oldRecommendations');
            
            recentDiv.innerHTML = '<h5>Most Recent Similar Papers:</h5>';
            oldDiv.innerHTML = '<h5>Oldest Similar Papers:</h5>';

            recentRecommendations.forEach(paper => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'recommendation-card';
                paperDiv.innerHTML = `
                    <strong>${paper.title}</strong><br>
                    <p>${paper.summary}</p>
                    <a href="${paper.link}" target="_blank">Read more</a><br>
                    <em>Source: ${paper.source} | Date: ${new Date(paper.pubDate).toLocaleString()}</em>
                `;
                recentDiv.appendChild(paperDiv);
            });

            oldRecommendations.forEach(paper => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'recommendation-card';
                paperDiv.innerHTML = `
                    <strong>${paper.title}</strong><br>
                    <p>${paper.summary}</p>
                    <a href="${paper.link}" target="_blank">Read more</a><br>
                    <em>Source: ${paper.source} | Date: ${new Date(paper.pubDate).toLocaleString()}</em>
                `;
                oldDiv.appendChild(paperDiv);
            });

            $('#recommendationModal').modal('show');
        }

        fetchSources();
        fetchPapers();
    </script>
</body>
</html>
